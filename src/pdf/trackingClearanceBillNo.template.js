export function trackingClearanceBillNoReportTemplate({
  BillNo,
  PortOfDischarge,
  result, // object or array
}) {
  const row = Array.isArray(result) ? (result[0] || {}) : (result || {});

  const vessel = (row?.VesselEnName ?? "").toString().trim();
  const billLabel = vessel ? "H/BL" : "AWB No";

  const status =
    row?.ClearanceDone ? "Cleared" :
    row?.ContainerUnderClearance ? "Under Clearance" :
    row?.UnderTracking ? "Under Tracking" :
    row?.AtThePort ? "At The Port" :
    "In progress";

  const badgeHtml =
    status === "Cleared"
      ? `<span class="badge arrived">STATUS: CLEARED</span>`
      : (status === "Under Clearance" || status === "Under Tracking")
        ? `<span class="badge departed">STATUS: ${escapeHtml(status.toUpperCase())}</span>`
        : status === "At The Port"
          ? `<span class="badge progress">STATUS: AT THE PORT</span>`
          : `<span class="badge progress">STATUS: IN PROGRESS</span>`;

  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    @page { size: A4; margin: 14mm 12mm; }
    body { font-family: Arial, sans-serif; color: #111; font-size: 12px; }
    .header { display:flex; align-items:center; justify-content:space-between; border-bottom: 2px solid #0b2a5b; padding-bottom: 10px; margin-bottom: 14px; }
    .logo { height: 42px; }
    .title { font-size: 18px; font-weight: 700; }
    .sub { font-size: 11px; color:#444; margin-top:4px; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size: 11px; }
    .badge.arrived { background:#e8fff0; border:1px solid #1f7a3a; color:#1f7a3a; }
    .badge.departed { background:#fff7e6; border:1px solid #b26a00; color:#b26a00; }
    .badge.progress { background:#eef3ff; border:1px solid #1f4fd6; color:#1f4fd6; }
    .grid { display:flex; gap:10px; margin-top: 10px; }
    .card { flex:1; border:1px solid #ddd; border-radius:10px; padding:10px; }
    .k { color:#444; font-size: 11px; }
    .v { font-weight:700; margin-top:2px; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:left; }
    th { background:#f5f5f5; }
    .footer { position: fixed; bottom: 0; left: 0; right: 0; font-size: 10px; color:#666; padding: 8mm 12mm; }
  </style>
</head>

<body>
  <div class="header">
    <div>
      <div class="title">Shipment Status Report</div>
      <div class="sub">Clearance • ${billLabel}: ${escapeHtml(BillNo)} • Port of Discharge: ${escapeHtml(PortOfDischarge)}</div>
    </div>
    <img class="logo" src="https://res.cloudinary.com/djvzbznry/image/upload/v1767658761/Al-zafer_Full_Logo_kz2l7t.png" />
  </div>

  <div>
    ${badgeHtml}
  </div>

  <div class="grid">
    <div class="card">
      <div class="k">${billLabel}</div>
      <div class="v">${escapeHtml(BillNo)}</div>
    </div>
    <div class="card">
      <div class="k">Port of Discharge</div>
      <div class="v">${escapeHtml(PortOfDischarge)}</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="k">Vessel Name</div>
      <div class="v">${escapeHtml(vessel || "-")}</div>
    </div>
    <div class="card">
      <div class="k">Current Status</div>
      <div class="v">${escapeHtml(status)}</div>
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="k">Key Dates</div>
    <table>
      <thead>
        <tr>
        <th>Under Clearance</th>
          <th>At The Port</th>
          <th>Clearance Done</th>
          <th>Under Trucking</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>${escapeHtml(formatDate(row?.ContainerUnderClearance) || "-")}</td>
          <td>${escapeHtml(formatDate(row?.AtThePort) || "-")}</td>
          <td>${escapeHtml(formatDate(row?.ClearanceDone) || "-")}</td>
          <td>${escapeHtml(formatDate(row?.UnderTracking) || "-")}</td>

        </tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    Generated by El-Zafer System • ${new Date().toISOString().slice(0,10)}
  </div>
</body>
</html>`;
}

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function formatDate(value) {
  if (!value) return "";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return String(value);
  return d.toLocaleDateString("en-GB");
}
